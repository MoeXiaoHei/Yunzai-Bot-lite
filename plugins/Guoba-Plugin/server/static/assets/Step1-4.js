import{b as e,ag as s,bF as t,bG as n,bh as o,w as a,bx as l,o as r,f as i,k as p,j as m,aj as d,x as u,bE as c,bB as f}from"./index.js";import{B as b}from"./BasicForm.js";import{a as j}from"./hooks.js";import g from"./StepBtn.js";import"./index5.js";import"./find.js";import"./_baseIteratee.js";import"./get.js";import"./index4.js";import"./index9.js";import"./useFormItem.js";/* empty css      */import"./transButton.js";import"./index2.js";import"./useWindowSizeFn.js";import"./FullscreenOutlined.js";import"./upperFirst.js";import"./download.js";import"./index7.js";import"./index6.js";import"./uniqBy.js";import"./lodash.default.js";import"./throttle.js";import"./merge.js";const v={class:"step-box"},h=d("div",{class:"step-tip"},"迁移配置",-1),x={class:"basic-form",key:"trans-form"},P=e({__name:"Step1-4",emits:["prev","next"],setup(e,{emit:P}){const M=s("setPageLoading",t),S=n("a",{onClick:function(){const{noPass:e}=J.value.jsPluginInfo;e.length>0?F({title:"不兼容的插件",width:600,content:n("span",[...e.map((e=>n("span",[C("插件名称",e.file),n("br"),C("原因",e.reason,"#ff7e7e"),n("br"),C("第"+e.lineNum+"行",e.line),n("br"),n("br")])))]),onOk:H}):H()}},"查看详情"),y=n("a",{onClick:R},"重新检测"),I=[S,n(o,{type:"vertical"}),y],[w,{models:J,registerForm:k}]=j({nextBtn:{text:"开始迁移"},schemas:[{field:"moduleTool",label:"安装依赖",component:"Select",componentProps:{options:[{label:"不安装",value:"none"},{label:"pnpm (推荐)",value:"pnpm"},{label:"npm",value:"npm"},{label:"cnpm",value:"cnpm"},{label:"yarn",value:"yarn"}]},bottomHelpMessage:"选择安装依赖的方式及工具"},{field:"transferJsMode",label:"单文件JS插件",component:"Select",componentProps:{options:[{label:"不迁移",value:"none"},{label:"仅迁移兼容的",value:"passed"},{label:"迁移所有插件",value:"force"}]},bottomHelpMessage:"选择迁移“单文件JS插件”的方式"},{field:"transferJsInfo",label:"迁移详情",component:"Input",render:()=>{var e,s;const t=J.value.jsPluginInfo;let o=(null==(e=t.passed)?void 0:e.length)||0,a=(null==(s=t.noPass)?void 0:s.length)||0,l=o+a;if(0===l)return"未检测到JS插件";let r=`检测到 ${l} 个JS插件，`;return r+=0===a?"全部可以迁移。":0===o?"全部不兼容。":`其中 ${a} 个不兼容， ${o} 个可以迁移。`,n("div",{},[r,I])},bottomHelpMessage:"",ifShow:({model:e})=>null!=J.value.jsPluginInfo.passed&&"passed"===e.transferJsMode},{field:"rubbishClean",label:"过滤垃圾文件",component:"Switch",helpMessage:["垃圾文件指的是：","1. 生成图片导致的html文件缓存。","（即以html为后缀的文件）","仅清理这一项，其他文件不清理。"],bottomHelpMessage:"是否过滤“data”文件夹中的垃圾文件"},{field:"redisClean",label:"Redis清理",component:"Switch",helpMessage:"如果你扔想保留V2的Redis数据，则不要清理。",bottomHelpMessage:"仅清理V2版本遗留的redis缓存（谨慎）"}]},{emit:P});a((()=>J.value.transferJsMode),(e=>{"passed"===e&&null==J.value.jsPluginInfo.passed&&R()}),{immediate:!0});const{createSuccessModal:B,createWarningModal:F}=f();function R(){return e=this,s=null,t=function*(){M(!0,"正在分析JS插件");try{let e=yield l.get({url:"/v2-transfer/check-js"},{errorMessageMode:"modal"});J.value.jsPluginInfo.passed=e.passed,J.value.jsPluginInfo.noPass=e.noPass}finally{M(!1)}},new Promise(((n,o)=>{var a=e=>{try{r(t.next(e))}catch(s){o(s)}},l=e=>{try{r(t.throw(e))}catch(s){o(s)}},r=e=>e.done?n(e.value):Promise.resolve(e.value).then(a,l);r((t=t.apply(e,s)).next())}));var e,s,t}function H(){const{passed:e}=J.value.jsPluginInfo;e.length>0&&B({title:"可迁移的插件",width:600,content:n("span",["注意事项：",n("br"),"1. 可迁移仅代表Guoba没有检测到不兼容的写法，不代表不会存在包括但不限于依赖缺失、其他不兼容的写法等问题。",n("br"),"2. 迁移到V3后，这些插件会运行在Guoba提供的“兼容V2插件”的容器里运行，如果存在报错将会拒绝执行插件，所以不用担心因报错无法启动的问题。",n("br"),n("br"),...e.map((e=>n("span",[C("插件名称",e.file),n("br")])))])})}function C(e,s,t="#333"){return n("span",[n("span",{},e+"："),n("span",{style:{color:t}},s)])}return(e,s)=>(r(),i("div",v,[h,p(c,{name:"fade-slide",mode:"out-in",appear:""},{default:m((()=>[d("div",x,[p(u(b),{onRegister:u(k)},null,8,["onRegister"])])])),_:1}),p(g,{onRegister:u(w)},null,8,["onRegister"])]))}});export{P as default};
